## 1、RestElasticsearchApi不支持的方法
```text
RestElasticsearchApi中以下方法暂不支持切面监听数据变更。
1、BulkResponse setListData(String index, String type, List beanList);
2、BulkResponse setListDataWithId(String index, String type, List beanList, String idFieldName);
3、BulkResponse setListDataWithParent(String index, String type, List beanList, String parentFieldName);
4、BulkResponse setListDataWithParentAndId(String index, String type, List<Object> beanList, String idFieldName, String parentFieldName);
5、JSONObject updateByQuery(String index, QueryBuilder queryBuilder, Script script);
6、Response deleteByQuery(String index, String type, QueryBuilder query);
```

## 2、如何监听数据更新事件
```text
只需实现com.kedacom.kem.event.handler.EventHandler接口，指定接口泛型为com.kedacom.kem.event.event.ResourceUpdateEvent
```
```java
//事件处理器
public interface EventHandler<T> {
    
    /**
     * 处理事件
     *
     * @param t
     */
    void handle(T t);
}

//数据变更事件
public class ResourceUpdateEvent {
    
    /**
     * 主键
     */
    private String id;
    
    /**
     * 索引
     */
    private String index;
    
    /**
     * 类型
     */
    private String type;
    
    /**
     * 操作类型
     */
    private OperationTypeEnums operationType;
    
    /**
     * 数据
     */
    private String content;
    
    /**
     * 自定义数据
     */
    private String customData;
    
    /**
     * 数据来源
     */
    private String source;
}

//例如监听数据变更然后发送Ctserver
@Slf4j
@ConditionalOnProperty(prefix = "map.data.sender", name = "enable", havingValue = "true", matchIfMissing = true)
@Component
public class CtEventHandler implements EventHandler<ResourceUpdateEvent> {
    static private Map<String, MapEsAliases> mapIndex = new HashMap<>();

    @Autowired
    CtServerService ctServerService;
    @Autowired
    private CtServerProperties properties;
    @Autowired
    private CtServerFeign ctServerFeign;
    @Autowired
    RestElasticsearchApi restElasticsearchApi;

    @Override
    public void handle(ResourceUpdateEvent resourceUpdateEvent) {

        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        if (mapIndex.size() == 0) {
            for (MapEsAliases value : MapEsAliases.values()) {
                mapIndex.put(value.getIndex(), value);
            }
        }
        if (!mapIndex.containsKey(resourceUpdateEvent.getIndex())) {
            log.info("该数据不在发送ctserver的序列;{}", resourceUpdateEvent.getIndex());
            return;
        }
        MapEsAliases mapEsAliases = mapIndex.get(resourceUpdateEvent.getIndex());
        if (resourceUpdateEvent.getOperationType()==null){
            return;
        }else if (resourceUpdateEvent.getOperationType().equals(OperationTypeEnums.DELETE)) {
            deleteCtData(mapEsAliases.getServiceName(),resourceUpdateEvent.getId());
        }else {
            GetResponse dataById = restElasticsearchApi.getDataById(mapEsAliases.getIndex(), mapEsAliases.getType(), resourceUpdateEvent.getId());
            Map<String, Object> source = dataById.getSource();
             if (source.getOrDefault("JLZT","1").toString().equals("0")){
                 deleteCtData(mapEsAliases.getServiceName(),resourceUpdateEvent.getId());
                 return;
             }
            CtDataWithShape ctData = new CtDataWithShape();
            dataHandle(source);
            ctData.setData(source);
            ctData.setId(resourceUpdateEvent.getId());
            shapeConvert(ctData, source);
            List<CtDataWithShape> ctDatas = new ArrayList<>();
            ctDatas.add(ctData);
            ctServerService.sendKafkaToCTServerWithAllShape(ctDatas,properties.getAppName(), mapEsAliases.getServiceName());
        }
    }

    private void deleteCtData(String serviceName,String id){
        CtServerBatchDeleteDTO ctServerBatchDeleteDTO = new CtServerBatchDeleteDTO();
        ctServerBatchDeleteDTO.setAppName(properties.getAppName());
        ctServerBatchDeleteDTO.setServiceName(serviceName);
        List<String> ids = new ArrayList<>();
        ids.add(id);
        ctServerBatchDeleteDTO.setDataIds(ids);
        ctServerFeign.bulkDelete(ctServerBatchDeleteDTO);
    }
    private void dataHandle(Map<String, Object> data){
        if (data.containsKey("XZNBBM")){
            String[] xznbbms = data.get("XZNBBM").toString().split(",");
            if (xznbbms.length>1){
                data.put("province",xznbbms[1]);
            }
            if (xznbbms.length>2){
                data.put("city",xznbbms[2]);
            }
            if (xznbbms.length>3){
                data.put("district",xznbbms[3]);
            }
        }
    }
    private void shapeConvert(CtDataWithShape ctData, Map source) {

        if (source.containsKey("SHAPE")) {
            JSONObject shape = JSONObject.parseObject(JSONObject.toJSONString(source.get("SHAPE")));
            if (shape.containsKey("type")&&shape.containsKey("coordinates")){
                ctData.setCoordinates(shape.getJSONArray("coordinates"));
                if (shape.getString("type").equalsIgnoreCase(ShapeType.POINT.getName())) {
                    ctData.setType(ShapeType.POINT);
                }else if (shape.getString("type").equalsIgnoreCase(ShapeType.LINESTRING.getName())) {
                    ctData.setType(ShapeType.LINESTRING);
                }else if (shape.getString("type").equalsIgnoreCase(ShapeType.POLYGON.getName())) {
                    ctData.setType(ShapeType.POLYGON);
                }
            }
        }
    }

}

```